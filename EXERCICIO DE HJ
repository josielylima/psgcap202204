CREATE PROCEDURE SP_INATIVAR_PERSISTENTE_FUNCIONARIO
@CONTADORFINAL INT
AS
BEGIN


DECLARE @TOTALREGISTROS INT
DECLARE @CHAVEINICIAL INT
DECLARE @CHAVESELECIONADA INT
DECLARE @QTDE INT

DECLARE @CONTADORINCIAL INT
--DECLARE @CONTADORFINAL INT
DECLARE @TABELACHAVE TABLE(CHAVE INT NOT NULL PRIMARY KEY)
DECLARE @VERIFICACHAVE INT

SET @CONTADORINCIAL = 0
--SET @CONTADORFINAL = 10
WHILE (@CONTADORINCIAL <= @CONTADORFINAL)
BEGIN                                                        
 SET @QTDE = 0
 SET @VERIFICACHAVE = 0
 WHILE(@QTDE = 0)
 BEGIN
	SET @TOTALREGISTROS = (SELECT COUNT(*) FROM PERSISTENTE)
	SET @CHAVEINICIAL = (SELECT MIN(ID_PERSISTENTE) FROM PERSISTENTE)
	SET @CHAVESELECIONADA = (SELECT FLOOR(RAND()*(@TOTALREGISTROS-@CHAVEINICIAL)+@CHAVEINICIAL))
	SET @QTDE = (SELECT COUNT(*) FROM PERSISTENTE WHERE ID_PERSISTENTE=(@CHAVESELECIONADA) AND ( SITUACAO = 'A'))
END

SET @VERIFICACHAVE = (SELECT COUNT (*) FROM @TABELACHAVE WHERE CHAVE = @CHAVESELECIONADA)
IF (@VERIFICACHAVE = 0)
BEGIN

 INSERT INTO @TABELACHAVE(CHAVE) VALUES (@CHAVESELECIONADA)
 SET @CONTADORINCIAL = @CONTADORINCIAL + 1
 END
END


 DECLARE DB_CURSOR CURSOR FOR
   SELECT CHAVE FROM @TABELACHAVE

	DECLARE @CHAVE INT

	OPEN DB_CURSOR
	FETCH NEXT FROM DB_CURSOR INTO @CHAVE

	WHILE @@FETCH_STATUS = 0
	BEGIN
	UPDATE PERSISTENTE
	SET SITUACAO = 'I'
	WHERE ID_PERSISTENTE = @CHAVE

	FETCH NEXT FROM DB_CURSOR INTO @CHAVE
END

	CLOSE DB_CURSOR
	DEALLOCATE DB_CURSOR
	
	END
	
	
 GO
